<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coach Robinson – Admin Dashboard</title>

    <style>
      body {
        font-family: sans-serif;
        background: #f7f7f7;
        margin: 0;
        padding: 2rem;
      }

      h1 {
        text-align: center;
        color: #222;
      }

      #reviewList {
        max-width: 700px;
        margin: 2rem auto;
      }

      .review {
        background: #fff;
        border-radius: 10px;
        padding: 1rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
      }

      .meta {
        font-size: 0.9rem;
        margin: 6px 0;
        color: #444;
      }

      /* Toggle Switch */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background-color: #bbb;
        transition: 0.3s;
        border-radius: 24px;
      }

      .slider:before {
        content: "";
        position: absolute;
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background: white;
        transition: 0.3s;
        border-radius: 50%;
      }

      .toggle-switch input:checked + .slider {
        background-color: #0ea5e9;
      }

      .toggle-switch input:checked + .slider:before {
        transform: translateX(26px);
      }

      /* Flash message */
      #flash {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #0ea5e9;
        color: white;
        padding: 0.8rem 1.2rem;
        border-radius: 6px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s;
      }

      #flash.show {
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <h1>Admin Review Dashboard</h1>

    <div id="reviewList"></div>
    <div id="flash"></div>

    <script>
      console.log("Admin dashboard JS loaded ✅");

      const API_BASE = "https://coachchris-api-production.up.railway.app/api";

      const flash = document.getElementById("flash");

      function showFlash(message) {
        flash.textContent = message;
        flash.classList.add("show");
        setTimeout(() => flash.classList.remove("show"), 2000);
      }

      // ------------------------
      // Load All Submissions/Reviews (Admin)
      // ------------------------
      async function loadSubmissions() {
        try {
          const res = await fetch(`${API_BASE}/submissions/all`);
          if (!res.ok) throw new Error("API error");

          const submissions = await res.json();

          const container = document.getElementById("reviewList");
          container.innerHTML = "";

          if (!submissions.length) {
            container.innerHTML = "<p>No Submissions found.</p>";
            return;
          }

          submissions.forEach((r) => {
            const div = document.createElement("div");
            div.className = "review";

            div.innerHTML = `
              <strong>${r.title}</strong> — <em>${r.reviewer_name}</em>
              <div class="meta">⭐ ${r.rating} | ${r.reviewer_role}</div>
              <p>${r.body}</p>

              <label class="toggle-switch">
                <input type="checkbox" data-id="${r.id}" ${
              r.published ? "checked" : ""
            }>
                <span class="slider"></span>
              </label>

              <span style="margin-left: 8px;">
                ${r.published ? "Published" : "Unpublished"}
              </span>
            `;

            container.appendChild(div);
          });

          attachToggleListeners();
        } catch (err) {
          console.error("Failed to load Submissions", err);
        }
      }

      // ------------------------
      // Toggle Published Status
      // ------------------------
      function attachToggleListeners() {
        document
          .querySelectorAll(".toggle-switch input")
          .forEach((checkbox) => {
            checkbox.addEventListener("change", async () => {
              const id = checkbox.dataset.id;
              const published = checkbox.checked;

              try {
                const res = await fetch(
                  `${API_BASE}/submissions/${id}/publish`,
                  {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ published }),
                  }
                );

                if (!res.ok) throw new Error("Failed to update");

                showFlash(
                  published ? "Review Published ✔" : "Review Unpublished ✖"
                );

                loadSubmissions();
              } catch (err) {
                console.error("Toggle error:", err);
                showFlash("⚠ Failed to update review");
              }
            });
          });
      }

      // Init
      loadSubmissions();
    </script>
  </body>
</html>
