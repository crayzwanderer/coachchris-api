<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coach Robinson – Admin Dashboard</title>

    <style>
      body {
        font-family: sans-serif;
        background: #f7f7f7;
        margin: 0;
        padding: 2rem;
      }
      h1 {
        text-align: center;
        color: #222;
      }

      #reviewList {
        max-width: 700px;
        margin: 2rem auto;
      }

      .review {
        background: #fff;
        border-radius: 10px;
        padding: 1rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #bbb;
        transition: 0.3s;
        border-radius: 24px;
      }
      .slider:before {
        content: "";
        position: absolute;
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background: white;
        transition: 0.3s;
        border-radius: 50%;
      }

      .toggle-switch input:checked + .slider {
        background-color: #0ea5e9;
      }
      .toggle-switch input:checked + .slider:before {
        transform: translateX(26px);
      }

      #flash {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #0ea5e9;
        color: white;
        padding: 0.8rem 1.2rem;
        border-radius: 6px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s;
      }
      #flash.show {
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <h1>Admin Review Dashboard</h1>

    <div id="reviewList"></div>
    <div id="flash"></div>

    <script>
      const API =
        "https://coachchris-api-production.up.railway.app/api/reviews";
      const flash = document.getElementById("flash");

      function showFlash(msg) {
        flash.textContent = msg;
        flash.classList.add("show");
        setTimeout(() => flash.classList.remove("show"), 2000);
      }

      async function loadReviews() {
        try {
          const res = await fetch(API); // ✅ CORRECT ROUTE
          const reviews = await res.json();

          const container = document.getElementById("reviewList");
          container.innerHTML = "";

          if (!reviews.length) {
            container.innerHTML = "<p>No reviews yet.</p>";
            return;
          }

          reviews.forEach((r) => {
            const div = document.createElement("div");
            div.className = "review";

            div.innerHTML = `
        <strong>${r.title}</strong> — <em>${r.reviewer_name}</em>
        <p>${r.body}</p>
        <div class="meta">⭐ ${r.rating} | ${r.reviewer_role}</div>

        <label class="toggle-switch">
          <input type="checkbox" data-id="${r.id}" ${
              r.published ? "checked" : ""
            }>
          <span class="slider"></span>
        </label>
        <span style="margin-left:8px;">${
          r.published ? "Published" : "Unpublished"
        }</span>
      `;

            container.appendChild(div);
          });

          attachToggleListeners();
        } catch (err) {
          console.error("Failed to load reviews:", err);
        }
      }

      function attachToggleListeners() {
        document.querySelectorAll("[data-id]").forEach((checkbox) => {
          checkbox.addEventListener("change", async () => {
            const id = checkbox.dataset.id;
            const published = checkbox.checked;

            try {
              const res = await fetch(`${API}/${id}/publish`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ published }),
              });

              if (!res.ok) throw new Error("Update failed");

              showFlash(
                published ? "Review Published ✔" : "Review Unpublished ✖"
              );
              loadReviews();
            } catch (err) {
              console.error("Publish toggle failed:", err);
              showFlash("⚠ Could not update review");
            }
          });
        });
      }

      loadReviews();
    </script>
  </body>
</html>
